#!/bin/bash

#setting a higher ulimit for open files, you might need to allow it for the user running electrum-sevrer in /etc/security/limits.conf first (see HOWTO)
ulimit -n 65536

if [ "$(id -u)" == "0" ]; then
   echo "Remember you don't have to run electrum server as root. Consider using a non priviled user." 1>&2
   # exit 1
fi

cd "$( dirname "${BASH_SOURCE[0]}" )"
PID=`/usr/bin/python server.py getpid`
if [[ $PID != *[!0-9]* ]]; then
    echo "Server already running (pid $PID)"
    exit
fi


electrum_config="/etc/electrum-ltc.conf"

if [ ! -f $electrum_config ]; then
    echo "$electrum_config does not exist"
    exit
fi

path=`grep -e ^path $electrum_config |awk -F\= '{print $2}' | tail -n 1`

if ! [ "$path" ]; then
    echo "Variable path not set in $electrum_config"
    exit
fi

rmdir $path --ignore-fail-on-non-empty

if [ ! -d $path ]; then
    echo "Database not found in $path."
    read -p "Do you want to download it from the Electrum-LTC foundry to $path ? " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
	mkdir -p $path
	wget -O - "http://foundry.electrum-ltc.org/leveldb-dump/electrum-fulltree-100-latest.tar.gz" | tar --extract --gunzip --strip-components 1 --directory $path --file -
    fi
fi

if [ electrum-ltc.log ]; then
    mv electrum-ltc.log electrum-ltc.log.1
fi

echo "Starting server as daemon"
nohup /usr/bin/python -u server.py &> electrum-ltc.log &
